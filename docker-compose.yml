# =============================================================================
# VIN OCR Pipeline - Docker Compose Configuration
# =============================================================================
# Deploy the VIN OCR application with automatic hardware detection
#
# Usage:
#   CPU only:        docker-compose up vin-ocr-cpu
#   NVIDIA GPU:      docker-compose up vin-ocr-gpu
#   With training:   docker-compose --profile training up
#
# Build:
#   docker-compose build
# =============================================================================

version: '3.8'

services:
  # ===========================================================================
  # CPU Version - Works on any machine
  # ===========================================================================
  vin-ocr-cpu:
    build:
      context: .
      dockerfile: docker/Dockerfile.cpu
    image: vin-ocr:cpu
    container_name: vin-ocr-cpu
    ports:
      - "8501:8501"
    volumes:
      # Persist data and models
      - ./data:/app/data
      - ./dataset:/app/dataset
      - ./output:/app/output
      - ./models:/app/models
      - ./finetune_data:/app/finetune_data
      # Mount configs (read-only)
      - ./configs:/app/configs:ro
    environment:
      - VIN_OCR_DEVICE=cpu
      - PADDLE_DEVICE=cpu
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ===========================================================================
  # NVIDIA GPU Version - Requires nvidia-docker
  # ===========================================================================
  vin-ocr-gpu:
    build:
      context: .
      dockerfile: docker/Dockerfile.gpu
    image: vin-ocr:gpu
    container_name: vin-ocr-gpu
    ports:
      - "8501:8501"
    volumes:
      # Persist data and models
      - ./data:/app/data
      - ./dataset:/app/dataset
      - ./output:/app/output
      - ./models:/app/models
      - ./finetune_data:/app/finetune_data
      # Mount configs (read-only)
      - ./configs:/app/configs:ro
    environment:
      - VIN_OCR_DEVICE=gpu
      - PADDLE_DEVICE=gpu
      - NVIDIA_VISIBLE_DEVICES=all
      - CUDA_VISIBLE_DEVICES=0
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ===========================================================================
  # Training Service (GPU) - For fine-tuning models
  # ===========================================================================
  vin-ocr-training:
    build:
      context: .
      dockerfile: docker/Dockerfile.gpu
    image: vin-ocr:gpu
    container_name: vin-ocr-training
    profiles:
      - training
    volumes:
      # Persist all training artifacts
      - ./data:/app/data
      - ./dataset:/app/dataset
      - ./output:/app/output
      - ./models:/app/models
      - ./finetune_data:/app/finetune_data
      - ./training_output:/app/training_output
      - ./configs:/app/configs:ro
    environment:
      - VIN_OCR_DEVICE=gpu
      - PADDLE_DEVICE=gpu
      - NVIDIA_VISIBLE_DEVICES=all
      - CUDA_VISIBLE_DEVICES=0
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    # Training command - override as needed
    command: ["python", "-m", "src.vin_ocr.training.finetune_paddleocr", "--help"]
    restart: "no"

# =============================================================================
# Volumes for persistent storage
# =============================================================================
volumes:
  vin-data:
    driver: local
  vin-models:
    driver: local
  vin-output:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  default:
    name: vin-ocr-network
